#!/bin/bash

compartment_id=`cat /root/.scripts/compid.out`;export region_id=`cat /root/.scripts/region.out`;/usr/local/bin/oci compute-management cluster-network list --compartment-id $compartment_id --region $region_id --query "data [?\"lifecycle-state\" !='STOPPING'].{Name:\"display-name\",state:\"lifecycle-state\",id:id,instancepoolid:\"instance-pools\"[].id,instancepoolname:\"instance-pools\"[].\"display-name\",instancepoolsize:\"instance-pools\"[].size}"  --output table | sed -e 's/'\''//g' | sed 's/[][]//g' > /root/.scripts/clusternetwork-metadata1-table.out

cat /root/.scripts/clusternetwork-metadata1-table.out
sed -i '$d' /root/.scripts/clusternetwork-metadata1-table.out;sed -i -e '1,3d' /root/.scripts/clusternetwork-metadata1-table.out

for clusternetworkid in `cat /root/.scripts/clusternetwork-metadata1-table.out | awk '{print $4}'` ; do echo;echo "$clusternetworkid: ";requestID=`/usr/local/bin/oci work-requests work-request list --compartment-id $compartment_id --resource-id $clusternetworkid | jq '.data | .[] | select(."operation-type"=="CreateClusterNetworkReservation") | .id'`;cn_work_request_error_messages=`/usr/local/bin/oci work-requests work-request-log-entry list --work-request-id ${requestID:1:-1} --region $region_id --all | jq '.data | .[] | .message '`;echo "$clusternetworkid $requestID $cn_work_request_error_messages";instancepoolid=`cat /root/.scripts/clusternetwork-metadata1-table.out | grep $clusternetworkid | awk '{print $6}'`;requestID=`/usr/local/bin/oci work-requests work-request list --compartment-id $compartment_id --resource-id $instancepoolid | jq '.data | .[] | select(."operation-type"=="LaunchInstancesInPool") | .id'`;inst_pool_work_request_error_messages=`/usr/local/bin/oci work-requests work-request-error list --work-request-id ${requestID:1:-1} --region $region_id --all | jq '.data | .[] | .message '`; echo $instancepoolid $requestID $instance_pool_work_request_error_messages;clusternetworkid=`cat /root/.scripts/clusternetwork-metadata1-table.out | grep $instancepoolid | awk '{print $4}'`;echo; done



#for instancepoolid in `cat /root/.scripts/clusternetwork-metadata1-table.out | awk '{print $6}'` ; do echo;echo "$instancepoolid: ";/usr/local/bin/oci compute-management instance-pool get --instance-pool-id $instancepoolid |jq -r '.data."size"';/usr/local/bin/oci compute-management instance-pool get --instance-pool-id $instancepoolid |jq -r '.data."lifecycle-state"';compartment_id=`cat /root/.scripts/compid.out`;export region_id=`cat /root/.scripts/region.out`;requestID=`/usr/local/bin/oci work-requests work-request list --compartment-id $compartment_id --resource-id $instancepoolid | jq '.data | .[] | select(."operation-type"=="LaunchInstancesInPool") | .id'`;inst_pool_work_request_error_messages=`/usr/local/bin/oci work-requests work-request-error list --work-request-id ${requestID:1:-1} --region $region_id --all | jq '.data | .[] | .message '`; echo $instancepoolid $requestID $instance_pool_work_request_error_messages;clusternetworkid=`cat /root/.scripts/clusternetwork-metadata1-table.out | grep $instancepoolid | awk '{print $4}'`;requestID=`/usr/local/bin/oci work-requests work-request list --compartment-id $compartment_id --resource-id $clusternetworkid | jq '.data | .[] | select(."operation-type"=="CreateClusterNetworkReservation") | .id'`;cn_work_request_error_messages=`/usr/local/bin/oci work-requests work-request-log-entry list --work-request-id ${requestID:1:-1} --region $region_id --all | jq '.data | .[] | .message '`;echo "$clusternetworkid $requestID $cn_work_request_error_messages";echo; done
